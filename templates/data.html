{% extends "base.html" %}

{% block title %}データ表示 - Dify-FLASK{% endblock %}

{% block content %}
<!-- アプリケーションタイトルバー -->
<div class="bg-dark text-white py-3 mb-4">
    <div class="container">
        <h1 class="h3 mb-0">仕入管理システム Ver2.0</h1>
    </div>
</div>

<div class="container">
    <!-- Bootstrapタブナビゲーション -->
    <div class="row mb-4">
        <div class="col-12">
            <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="file-import-tab" data-bs-toggle="tab" data-bs-target="#file-import" type="button" role="tab" aria-controls="file-import" aria-selected="true">ファイル取込</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="basic-info-tab" data-bs-toggle="tab" data-bs-target="#basic-info" type="button" role="tab" aria-controls="basic-info" aria-selected="false">基本情報</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="inventory-list-tab" data-bs-toggle="tab" data-bs-target="#inventory-list" type="button" role="tab" aria-controls="inventory-list" aria-selected="false">仕入一覧</button>
                </li>
            </ul>
        </div>
    </div>

    <!-- タブコンテンツ -->
    <div class="tab-content" id="myTabContent">
        <!-- ファイル取込タブ -->
        <div class="tab-pane fade show active" id="file-import" role="tabpanel" aria-labelledby="file-import-tab">
            <div class="row mb-3">
                <div class="col-12">
                    <h2 class="h4">ファイル取込</h2>
                </div>
            </div>
            
            <!-- ファイルアップロードエリア -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">画像ファイル選択</h5>
                        </div>
                        <div class="card-body">
                            <form id="uploadForm" enctype="multipart/form-data">
                                <div class="mb-3">
                                    <label for="fileInput" class="form-label">PNG画像を選択してください（複数選択可能）</label>
                                    <input type="file" class="form-control" id="fileInput" name="files" accept=".png" multiple required>
                                    <div class="form-text">対応形式: PNG画像のみ（各ファイル最大16MB、複数選択可能）</div>
                                </div>
                                
                                <div class="text-center">
                                    <button type="submit" class="btn btn-primary btn-lg" id="analyzeBtn">
                                        <span id="btnText">分析開始</span>
                                        <span id="btnSpinner" class="spinner-border spinner-border-sm d-none ms-2" role="status"></span>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 単一リトライボタン（全分析完了後、失敗がある場合のみ表示） -->
            <div id="retryButtonArea" class="mb-3 text-center d-none">
                <button type="button" class="btn btn-warning" id="retryFailedBtn">
                    <i class="fas fa-redo"></i> 失敗したファイルをリトライ
                </button>
            </div>
            
            <!-- ファイル進捗表示エリア -->
            <div id="fileProgressArea" class="mt-3 d-none">
                <div class="card">
                    <div class="card-header py-2">
                        <h6 class="mb-0">選択されたファイル</h6>
                    </div>
                    <div class="card-body py-2">
                        <div id="fileProgressList" class="list-group list-group-flush">
                            <!-- ファイルリストがここに動的に追加されます -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 結果表示エリア -->
            <div id="resultArea" class="mt-4 d-none">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">分析結果</h5>
                    </div>
                    <div class="card-body">
                        <div id="resultContent"></div>
                    </div>
                </div>
            </div>
            
            <!-- エラー表示エリア -->
            <div id="errorArea" class="mt-4 d-none">
                <div class="alert alert-danger" role="alert">
                    <h6>エラーが発生しました</h6>
                    <div id="errorContent"></div>
                </div>
            </div>

        </div>

        <!-- 基本情報タブ -->
        <div class="tab-pane fade" id="basic-info" role="tabpanel" aria-labelledby="basic-info-tab">
            <!-- セクションタイトル -->
            <div class="row mb-3">
                <div class="col-12">
                    <h2 class="h4">基本情報一覧</h2>
                </div>
            </div>

            <!-- アクションボタン -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-success" onclick="saveSelectedData()">選択データを保存</button>
                        <button type="button" class="btn btn-danger" onclick="deleteAllData()">全データ削除</button>
                    </div>
                </div>
            </div>

            <!-- テーブル形式でのデータ表示 -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">データ一覧</h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover mb-0">
                                    <thead class="bg-dark text-white">
                                        <tr>
                                            <th style="width: 40px;">
                                                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" checked>
                                            </th>
                                            <th style="width: 60px;">ページ</th>
                                            <th style="width: 100px;">出荷日</th>
                                            <th style="width: 120px;">受注番号</th>
                                            <th style="width: 140px;">納入先番号</th>
                                            <th style="width: 100px;">担当者</th>
                                            <th style="width: 120px;">税抜合計</th>
                                            <th style="width: 120px;">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tableBody">
                                        <!-- テーブルデータはJavaScriptで動的に生成 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- デバッグ用：JSONデータ表示 -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">デバッグ用：分析結果データ</h5>
                        </div>
                        <div class="card-body">
                            <div id="debugDataArea">
                                <!-- JSONデータがここに表示されます -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 仕入一覧タブ -->
        <div class="tab-pane fade" id="inventory-list" role="tabpanel" aria-labelledby="inventory-list-tab">
            <div class="row mb-3">
                <div class="col-12">
                    <h2 class="h4">仕入一覧</h2>
                    <p class="text-muted">保存されたデータの一覧を表示します</p>
                </div>
            </div>
            
            <!-- 保存されたデータのテーブル -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">保存済みデータ一覧</h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover mb-0">
                                    <thead class="bg-dark text-white">
                                        <tr>
                                            <th style="width: 60px;">ページ</th>
                                            <th style="width: 100px;">出荷日</th>
                                            <th style="width: 120px;">受注番号</th>
                                            <th style="width: 140px;">納入先番号</th>
                                            <th style="width: 100px;">担当者</th>
                                            <th style="width: 120px;">税抜合計</th>
                                        </tr>
                                    </thead>
                                    <tbody id="savedDataTableBody">
                                        <!-- 保存されたデータがここに表示されます -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<!-- 削除確認用モーダル -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmModalLabel">削除確認</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="deleteConfirmMessage">この行を削除しますか？</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn" onclick="confirmDelete()">削除</button>
            </div>
        </div>
    </div>
</div>

<!-- 全データ削除確認用モーダル -->
<div class="modal fade" id="deleteAllConfirmModal" tabindex="-1" aria-labelledby="deleteAllConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteAllConfirmModalLabel">全データ削除確認</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>すべてのデータを削除しますか？この操作は取り消せません。</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteAllData()">全削除</button>
            </div>
        </div>
    </div>
</div>

<!-- データ追加用モーダル -->
<div class="modal fade" id="addDataModal" tabindex="-1" aria-labelledby="addDataModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addDataModalLabel">データ追加</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addDataForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="addPage" class="form-label">ページ</label>
                                <input type="text" class="form-control" id="addPage" name="ページ" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="addShippingDate" class="form-label">出荷日</label>
                                <input type="text" class="form-control" id="addShippingDate" name="出荷日" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="addOrderNumber" class="form-label">受注番号</label>
                                <input type="text" class="form-control" id="addOrderNumber" name="受注番号" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="addDeliveryNumber" class="form-label">納入先番号</label>
                                <input type="text" class="form-control" id="addDeliveryNumber" name="納入先番号" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="addResponsiblePerson" class="form-label">担当者</label>
                                <input type="text" class="form-control" id="addResponsiblePerson" name="担当者" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="addTotalAmount" class="form-label">税抜合計</label>
                                <input type="text" class="form-control" id="addTotalAmount" name="税抜合計" required>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-success" onclick="confirmAddData()">追加</button>
            </div>
        </div>
    </div>
</div>

<!-- 編集用モーダル -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">データ編集</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editPage" class="form-label">ページ</label>
                                <input type="text" class="form-control" id="editPage" name="ページ">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editShippingDate" class="form-label">出荷日</label>
                                <input type="text" class="form-control" id="editShippingDate" name="出荷日">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editOrderNumber" class="form-label">受注番号</label>
                                <input type="text" class="form-control" id="editOrderNumber" name="受注番号">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editDeliveryNumber" class="form-label">納入先番号</label>
                                <input type="text" class="form-control" id="editDeliveryNumber" name="納入先番号">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editResponsiblePerson" class="form-label">担当者</label>
                                <input type="text" class="form-control" id="editResponsiblePerson" name="担当者">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editTotalAmount" class="form-label">税抜合計</label>
                                <input type="text" class="form-control" id="editTotalAmount" name="税抜合計">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-primary" onclick="saveEdit()">保存</button>
            </div>
        </div>
    </div>
</div>

<script>
// グローバル変数として現在のデータを管理
let currentData = [];
let currentEditIndex = -1;

// デバッグ用：JSONデータをそのまま表示する機能
function loadTableData() {
    try {
        // トップページで表示されている分析結果のデータを取得
        // ローカルストレージまたはセッションストレージから取得を試行
        let analysisData = null;
        
                    // ローカルストレージから取得を試行
            const localData = localStorage.getItem('analysisResults');
            if (localData) {
                analysisData = JSON.parse(localData);
            }
            
            // セッションストレージから取得を試行
            if (!analysisData) {
                const sessionData = sessionStorage.getItem('analysisResults');
                if (sessionData) {
                    analysisData = JSON.parse(sessionData);
                }
            }
        
        if (analysisData && analysisData.length > 0) {
            console.log('取得した分析データ:', analysisData);
            console.log('データの長さ:', analysisData.length);
            
            // textフィールドからJSONデータを抽出してパース
            let actualData = [];
            try {
                // すべてのanalysisDataのtextフィールドを処理
                analysisData.forEach((item, index) => {
                    if (item && item.text) {
                        // textフィールドからJSON部分を抽出
                        const jsonMatch = item.text.match(/```json\s*\n(.*?)\n```/s);
                        if (jsonMatch) {
                            const parsedData = JSON.parse(jsonMatch[1]);
                            // パースされたデータが配列の場合は展開、オブジェクトの場合は配列に追加
                            if (Array.isArray(parsedData)) {
                                actualData = actualData.concat(parsedData);
                            } else {
                                actualData.push(parsedData);
                            }
                        }
                    }
                });
                
                console.log('パースされた実際のデータ:', actualData);
                console.log('実際のデータの長さ:', actualData.length);
            } catch (parseError) {
                console.error('JSONパースエラー:', parseError);
            }
            
            // 実際のデータを表示
            const debugArea = document.getElementById('debugDataArea');
            if (debugArea) {
                if (actualData.length > 0) {
                    debugArea.innerHTML = `
                        <h6>パースされたデータ（${actualData.length}件）:</h6>
                        <pre>${JSON.stringify(actualData, null, 2)}</pre>
                    `;
                    
                    // グローバル変数にデータを設定
                    currentData = actualData;
                    
                    // テーブルにもデータを表示
                    displayTableData(actualData);
                } else {
                    debugArea.innerHTML = `
                        <h6>元のデータ:</h6>
                        <pre>${JSON.stringify(analysisData, null, 2)}</pre>
                    `;
                }
            }
        } else {
            // データがない場合
            console.log('分析データが見つかりません');
            const debugArea = document.getElementById('debugDataArea');
            if (debugArea) {
                debugArea.innerHTML = '<p>分析データが見つかりません</p>';
            }
        }
    } catch (error) {
        console.error('データの読み込みに失敗しました:', error);
        const debugArea = document.getElementById('debugDataArea');
        if (debugArea) {
            debugArea.innerHTML = `<p>エラーが発生しました: ${error.message}</p>`;
        }
    }
}

// 金額にカンマを追加する関数
function addCommas(value) {
    if (typeof value === 'string' && value !== 'N/A') {
        // 既存のカンマを除去してから数値として処理
        const numValue = value.replace(/,/g, '');
        if (!isNaN(numValue)) {
            return parseInt(numValue).toLocaleString();
        }
    }
    return value;
}

// テーブルにデータを表示する関数
function displayTableData(data) {
    const tableBody = document.getElementById('tableBody');
    if (!tableBody) return;
    
    let html = '';
    
    data.forEach((item, index) => {
        html += '<tr>';
        html += `<td><input type="checkbox" class="row-checkbox" value="${index}" onchange="updateSelectAllState()" checked></td>`;
        html += `<td>${item.ページ || 'N/A'}</td>`;
        html += `<td>${item.出荷日 || 'N/A'}</td>`;
        html += `<td>${item.受注番号 || 'N/A'}</td>`;
        html += `<td>${item.納入先番号 || 'N/A'}</td>`;
        html += `<td>${item.担当者 || 'N/A'}</td>`;
        html += `<td>${addCommas(item.税抜合計) || 'N/A'}</td>`;
        html += '<td>';
        html += '<div class="d-flex gap-1">';
        html += `<button type="button" class="btn btn-warning btn-sm" onclick="editRow(${index})">編集</button>`;
        html += `<button type="button" class="btn btn-danger btn-sm" onclick="deleteRow(${index})">削除</button>`;
        html += `<button type="button" class="btn btn-success btn-sm" onclick="addRow(${index})">追加</button>`;
        html += '</div>';
        html += '</td>';
        html += '</tr>';
    });
    
    tableBody.innerHTML = html;
}

// グローバル変数：現在編集中のデータ
currentEditIndex = -1;
currentData = [];

// 編集ボタンクリック時の処理
function editRow(index) {
    if (index >= 0 && index < currentData.length) {
        currentEditIndex = index;
        
        // モーダルにデータを設定
        const item = currentData[index];
        document.getElementById('editPage').value = item.ページ || '';
        document.getElementById('editShippingDate').value = item.出荷日 || '';
        document.getElementById('editOrderNumber').value = item.受注番号 || '';
        document.getElementById('editDeliveryNumber').value = item.納入先番号 || '';
        document.getElementById('editResponsiblePerson').value = item.担当者 || '';
        // 税抜合計はカンマを除去して表示
        document.getElementById('editTotalAmount').value = (item.税抜合計 || '').replace(/,/g, '');
        
        // モーダルを表示
        const editModal = new bootstrap.Modal(document.getElementById('editModal'));
        editModal.show();
    }
}

// 保存ボタンクリック時の処理
function saveEdit() {
    if (currentEditIndex === -1) return;
    
    // フォームから値を取得
    const updatedItem = {
        ページ: document.getElementById('editPage').value,
        出荷日: document.getElementById('editShippingDate').value,
        受注番号: document.getElementById('editOrderNumber').value,
        納入先番号: document.getElementById('editDeliveryNumber').value,
        担当者: document.getElementById('editResponsiblePerson').value,
        税抜合計: document.getElementById('editTotalAmount').value
    };
    
    // データを更新
    currentData[currentEditIndex] = { ...currentData[currentEditIndex], ...updatedItem };
    
    // ローカルストレージを更新
    const sessionData = sessionStorage.getItem('analysisResults');
    if (sessionData) {
        const analysisData = JSON.parse(sessionData);
        if (analysisData[0] && analysisData[0].text) {
            // 更新されたデータでtextフィールドを再構築
            const updatedText = analysisData[0].text.replace(
                /```json\s*\n.*?\n```/s,
                `\`\`\`json\n${JSON.stringify(currentData, null, 2)}\n\`\`\``
            );
            analysisData[0].text = updatedText;
            
            // 更新されたデータを保存
            sessionStorage.setItem('analysisResults', JSON.stringify(analysisData));
            localStorage.setItem('analysisResults', JSON.stringify(analysisData));
        }
    }
    
    // テーブルを再表示
    displayTableData(currentData);
    
    // モーダルを閉じる
    const editModal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
    editModal.hide();
    

}

// 削除ボタンクリック時の処理
function deleteRow(index) {
    // 受注番号を取得して確認メッセージを設定
    const item = currentData[index];
    const orderNumber = item.受注番号 || 'N/A';
    
    // 確認メッセージを更新
    document.getElementById('deleteConfirmMessage').innerHTML = 
        `受注番号：<strong>${orderNumber}</strong><br>この行を削除しますか？`;
    
    // 削除対象のインデックスを保存
    window.deleteTargetIndex = index;
    
    // 削除確認モーダルを表示
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    deleteModal.show();
}

// 削除確認後の実際の削除処理
function confirmDelete() {
    const index = window.deleteTargetIndex;
    if (index !== undefined) {
        // 指定された行を削除（currentDataから直接削除）
        currentData.splice(index, 1);
        
        // データが残っている場合は更新、空になった場合は完全削除
        if (currentData.length > 0) {
            // ローカルストレージを更新
            const sessionData = sessionStorage.getItem('analysisResults');
            if (sessionData) {
                const analysisData = JSON.parse(sessionData);
                if (analysisData[0] && analysisData[0].text) {
                    // 更新されたデータでtextフィールドを再構築
                    const updatedText = analysisData[0].text.replace(
                        /```json\s*\n.*?\n```/s,
                        `\`\`\`json\n${JSON.stringify(currentData, null, 2)}\n\`\`\``
                    );
                    analysisData[0].text = updatedText;
                    
                    // 更新されたデータを保存
                    sessionStorage.setItem('analysisResults', JSON.stringify(analysisData));
                    localStorage.setItem('analysisResults', JSON.stringify(analysisData));
                }
            }
        } else {
            // データが空になった場合は完全に削除
            localStorage.removeItem('analysisResults');
            sessionStorage.removeItem('analysisResults');
        }
        
        // テーブルを再表示
        displayTableData(currentData);
        
        // モーダルを閉じる
        const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
        deleteModal.hide();
        
        // 削除対象インデックスをクリア
        window.deleteTargetIndex = undefined;
    }
}

// 追加ボタンクリック時の処理
function addRow(index) {
    // 追加対象のインデックスを保存（次の行に挿入するため+1）
    window.addTargetIndex = index + 1;
    
    // クリックした行のデータを取得
    const sourceItem = currentData[index];
    
    // フォームに初期値としてコピーしたデータを設定
    document.getElementById('addPage').value = sourceItem.ページ || '';
    document.getElementById('addShippingDate').value = sourceItem.出荷日 || '';
    document.getElementById('addOrderNumber').value = sourceItem.受注番号 || '';
    document.getElementById('addDeliveryNumber').value = sourceItem.納入先番号 || '';
    document.getElementById('addResponsiblePerson').value = sourceItem.担当者 || '';
    // 税抜合計はカンマを除去して表示
    document.getElementById('addTotalAmount').value = (sourceItem.税抜合計 || '').replace(/,/g, '');
    
    // データ追加モーダルを表示
    const addModal = new bootstrap.Modal(document.getElementById('addDataModal'));
    addModal.show();
}

// データ追加確認後の実際の追加処理
function confirmAddData() {
    const index = window.addTargetIndex;
    if (index !== undefined) {
        // フォームから値を取得
        const newItem = {
            ページ: document.getElementById('addPage').value,
            出荷日: document.getElementById('addShippingDate').value,
            受注番号: document.getElementById('addOrderNumber').value,
            納入先番号: document.getElementById('addDeliveryNumber').value,
            担当者: document.getElementById('addResponsiblePerson').value,
            税抜合計: document.getElementById('addTotalAmount').value
        };
        
        // 指定された位置に新しいデータを挿入
        currentData.splice(index, 0, newItem);
        
        // ローカルストレージを更新
        const sessionData = sessionStorage.getItem('analysisResults');
        if (sessionData) {
            const analysisData = JSON.parse(sessionData);
            if (analysisData[0] && analysisData[0].text) {
                // 更新されたデータでtextフィールドを再構築
                const updatedText = analysisData[0].text.replace(
                    /```json\s*\n.*?\n```/s,
                    `\`\`\`json\n${JSON.stringify(currentData, null, 2)}\n\`\`\``
                );
                analysisData[0].text = updatedText;
                
                // 更新されたデータを保存
                sessionStorage.setItem('analysisResults', JSON.stringify(analysisData));
                localStorage.setItem('analysisResults', JSON.stringify(analysisData));
            }
        }
        
        // テーブルを再表示
        displayTableData(currentData);
        
        // モーダルを閉じる
        const addModal = bootstrap.Modal.getInstance(document.getElementById('addDataModal'));
        addModal.hide();
        
        // 追加対象インデックスをクリア
        window.addTargetIndex = undefined;
    }
}

// 全選択チェックボックスの状態を切り替え
function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAll');
    const rowCheckboxes = document.querySelectorAll('.row-checkbox');
    
    rowCheckboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });
}

// 個別チェックボックスの状態に基づいて全選択チェックボックスの状態を更新
function updateSelectAllState() {
    const selectAllCheckbox = document.getElementById('selectAll');
    const rowCheckboxes = document.querySelectorAll('.row-checkbox');
    const checkedCount = document.querySelectorAll('.row-checkbox:checked').length;
    
    if (checkedCount === 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
    } else if (checkedCount === rowCheckboxes.length) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
    } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
    }
}

// 選択されたデータを保存
function saveSelectedData() {
    const selectedCheckboxes = document.querySelectorAll('.row-checkbox:checked');
    
    if (selectedCheckboxes.length === 0) {
        alert('保存するデータを選択してください。');
        return;
    }
    
    // 選択されたデータを取得
    const selectedData = [];
    selectedCheckboxes.forEach(checkbox => {
        const index = parseInt(checkbox.value);
        if (index >= 0 && index < currentData.length) {
            selectedData.push(currentData[index]);
        }
    });
    
    // サーバーに保存
    fetch('/api/analysis/results', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            results: selectedData
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`選択された${selectedData.length}件のデータを保存しました。`);
            
            // 保存されたデータをcurrentDataから削除
            // インデックスがずれないように、後ろから削除
            const sortedIndices = Array.from(selectedCheckboxes)
                .map(checkbox => parseInt(checkbox.value))
                .sort((a, b) => b - a); // 降順でソート
            
            sortedIndices.forEach(index => {
                if (index >= 0 && index < currentData.length) {
                    currentData.splice(index, 1);
                }
            });
            
            // 更新されたデータでテーブルを再表示
            displayTableData(currentData);
            
            // ローカルストレージとセッションストレージを更新
            if (currentData.length > 0) {
                // 残りのデータがある場合は更新
                const sessionData = sessionStorage.getItem('analysisResults');
                if (sessionData) {
                    const analysisData = JSON.parse(sessionData);
                    if (analysisData[0] && analysisData[0].text) {
                        // 更新されたデータでtextフィールドを再構築
                        const updatedText = analysisData[0].text.replace(
                            /```json\s*\n.*?\n```/s,
                            `\`\`\`json\n${JSON.stringify(currentData, null, 2)}\n\`\`\``
                        );
                        analysisData[0].text = updatedText;
                        
                        // 更新されたデータを保存
                        sessionStorage.setItem('analysisResults', JSON.stringify(analysisData));
                        localStorage.setItem('analysisResults', JSON.stringify(analysisData));
                    }
                }
            } else {
                // データが空になった場合は完全に削除
                localStorage.removeItem('analysisResults');
                sessionStorage.removeItem('analysisResults');
            }
            
            // デバッグエリアも更新
            const debugArea = document.getElementById('debugDataArea');
            if (debugArea) {
                if (currentData.length > 0) {
                    debugArea.innerHTML = `
                        <h6>パースされたデータ（${currentData.length}件）:</h6>
                        <pre>${JSON.stringify(currentData, null, 2)}</pre>
                    `;
                } else {
                    debugArea.innerHTML = '<p>データが保存されました</p>';
                }
            }
            
            // チェックボックスをクリア
            document.querySelectorAll('.row-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            document.getElementById('selectAll').checked = false;
            document.getElementById('selectAll').indeterminate = false;
        } else {
            alert('データの保存に失敗しました: ' + data.error);
        }
    })
    .catch(error => {
        console.error('保存エラー:', error);
        alert('データの保存中にエラーが発生しました。');
    });
}

// 全データ削除ボタンクリック時の処理
function deleteAllData() {
    // 全データ削除確認モーダルを表示
    const deleteAllModal = new bootstrap.Modal(document.getElementById('deleteAllConfirmModal'));
    deleteAllModal.show();
}

// 全データ削除確認後の実際の削除処理
function confirmDeleteAllData() {
    // currentDataを空にする
    currentData = [];
    
    // ローカルストレージとセッションストレージから完全に削除
    localStorage.removeItem('analysisResults');
    sessionStorage.removeItem('analysisResults');
    
    // テーブルを再表示（空のデータ）
    displayTableData(currentData);
    
    // デバッグエリアも更新
    const debugArea = document.getElementById('debugDataArea');
    if (debugArea) {
        debugArea.innerHTML = '<p>データが削除されました</p>';
    }
    
    // モーダルを閉じる
    const deleteAllModal = bootstrap.Modal.getInstance(document.getElementById('deleteAllConfirmModal'));
    deleteAllModal.hide();
}

// ページ読み込み時にデータを表示
document.addEventListener('DOMContentLoaded', function() {
    loadTableData();
    
    // タブの切り替えイベントを設定
    const inventoryListTab = document.getElementById('inventory-list-tab');
    if (inventoryListTab) {
        inventoryListTab.addEventListener('click', function() {
            loadSavedData();
        });
    }
});

// 保存されたデータを読み込んで表示
function loadSavedData() {
    fetch('/api/analysis/results', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displaySavedData(data.results);
        } else {
            console.error('保存されたデータの取得に失敗しました:', data.error);
            displaySavedData([]);
        }
    })
    .catch(error => {
        console.error('データ取得エラー:', error);
        displaySavedData([]);
    });
}

// 保存されたデータをテーブルに表示（操作ボタンなし）
function displaySavedData(data) {
    const tableBody = document.getElementById('savedDataTableBody');
    if (!tableBody) return;
    
    let html = '';
    
    if (data.length === 0) {
        html = '<tr><td colspan="6" class="text-center text-muted">保存されたデータがありません</td></tr>';
    } else {
        data.forEach((item, index) => {
            html += '<tr>';
            html += `<td>${item.ページ || 'N/A'}</td>`;
            html += `<td>${item.出荷日 || 'N/A'}</td>`;
            html += `<td>${item.受注番号 || 'N/A'}</td>`;
            html += `<td>${item.納入先番号 || 'N/A'}</td>`;
            html += `<td>${item.担当者 || 'N/A'}</td>`;
            html += `<td>${addCommas(item.税抜合計) || 'N/A'}</td>`;
            html += '</tr>';
        });
    }
    
    tableBody.innerHTML = html;
}

// ファイルアップロードフォームの処理
document.addEventListener('DOMContentLoaded', function() {
    const uploadForm = document.getElementById('uploadForm');
    if (uploadForm) {
        uploadForm.addEventListener('submit', handleFileUpload);
    }
    
    // 必要な要素の参照を取得
    window.fileProgressList = document.getElementById('fileProgressList');
    window.fileProgressArea = document.getElementById('fileProgressArea');
    window.retryButtonArea = document.getElementById('retryButtonArea');
    window.retryFailedBtn = document.getElementById('retryFailedBtn');
    window.resultContent = document.getElementById('resultContent');
    window.resultArea = document.getElementById('resultArea');
    window.errorArea = document.getElementById('errorArea');
    window.errorContent = document.getElementById('errorContent');
});

// ファイルアップロード処理
function handleFileUpload(event) {
    event.preventDefault();
    
    const fileInput = document.getElementById('fileInput');
    const files = fileInput.files;
    
    if (files.length === 0) {
        alert('ファイルを選択してください。');
        return;
    }
    
    if (files.length > 10) {
        alert('最大10ファイルまで選択できます。');
        return;
    }
    
    // ボタンの状態を変更
    const analyzeBtn = document.getElementById('analyzeBtn');
    const btnText = document.getElementById('btnText');
    const btnSpinner = document.getElementById('btnSpinner');
    
    analyzeBtn.disabled = true;
    btnText.textContent = '分析中...';
    btnSpinner.classList.remove('d-none');
    
    // FormDataを作成
    const formData = new FormData();
    for (let i = 0; i < files.length; i++) {
        formData.append('files', files[i]);
    }
    

    
    // ファイルリストを表示
    displayFileList(files);
    
    // サーバーにアップロード
    fetch('/api/dify/analyze-sequential', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            startPollingForResults(data.session_id, data.total_files);
        } else {
            const errorMessage = data.error || '処理開始に失敗しました';
            displayError(errorMessage);
            // ボタンの状態をリセット
            const analyzeBtn = document.getElementById('analyzeBtn');
            const btnText = document.getElementById('btnText');
            const btnSpinner = document.getElementById('btnSpinner');
            
            if (analyzeBtn && btnText && btnSpinner) {
                analyzeBtn.disabled = false;
                btnText.textContent = '分析開始';
                btnSpinner.classList.add('d-none');
            }
        }
    })
    .catch(error => {
        const errorMessage = '処理開始中にエラーが発生しました';
        displayError(errorMessage);
        console.error('Sequential processing error:', error);
        // ボタンの状態をリセット
        const analyzeBtn = document.getElementById('analyzeBtn');
        const btnText = document.getElementById('btnText');
        const btnSpinner = document.getElementById('btnSpinner');
        
        if (analyzeBtn && btnText && btnSpinner) {
            analyzeBtn.disabled = false;
            btnText.textContent = '分析開始';
            btnSpinner.classList.add('d-none');
        }
    });
}

// ファイルリストを表示
function displayFileList(files) {
    if (!fileProgressList || !fileProgressArea) return;
    
    // 常に進捗表示エリアを表示
    let html = '';
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        if (isValidPNGFile(file) && file.size <= 16 * 1024 * 1024) {
            html += `<div class="file-progress-item" data-file-index="${i}">`;
            html += `<span class="file-name">${file.name}</span>`;
            html += `<span class="file-status">⏳ 待機中</span>`;
            html += `</div>`;
        }
    }
    
    fileProgressList.innerHTML = html;
    showElement(fileProgressArea);
}

// ファイル進捗を更新
function updateFileProgress(results) {
    if (!fileProgressList) return;
    
    results.forEach(result => {
        const fileItem = fileProgressList.querySelector(`[data-file-index="${result.file_index}"]`);
        if (fileItem) {
            const statusElement = fileItem.querySelector('.file-status');
            if (statusElement) {
                const elapsedText = result.elapsed_seconds ? ` (${result.elapsed_seconds}秒)` : '';
                const attemptText = result.current_attempt ? ` (${result.current_attempt}回目)` : '';
                
                if (result.failed) {
                    statusElement.innerHTML = `❌ 失敗${attemptText}${elapsedText}`;
                    statusElement.style.color = '#dc3545';
                    fileItem.classList.add('failed');
                    fileItem.classList.remove('completed', 'processing');
                } else {
                    statusElement.innerHTML = `✅ 完了${attemptText}${elapsedText}`;
                    statusElement.style.color = '#28a745';
                    fileItem.classList.add('completed');
                    fileItem.classList.remove('failed', 'processing');
                }
            }
        }
    });
}

// 現在処理中のファイルの状態を更新
function updateCurrentProcessingStatus(processingInfo) {
    if (!fileProgressList || !processingInfo) return;
    
    const fileItem = fileProgressList.querySelector(`[data-file-index="${processingInfo.file_index}"]`);
    if (fileItem) {
        const statusElement = fileItem.querySelector('.file-status');
        if (statusElement) {
            const attemptText = `${processingInfo.current_attempt}回目分析中`;
            statusElement.innerHTML = `🔄 ${attemptText}`;
            statusElement.innerHTML = `🔄 ${attemptText}`;
            statusElement.style.color = '#007bff';
            fileItem.classList.add('processing');
            fileItem.classList.remove('completed', 'failed');
        }
    }
}

// リトライボタンの表示/非表示を制御
function checkRetryButtonVisibility(allResults, isCompleted) {
    if (!retryButtonArea || !retryFailedBtn) return;
    
    if (isCompleted && allResults.some(result => result.failed)) {
        showElement(retryButtonArea);
    } else {
        hideElement(retryButtonArea);
    }
}

// セッション結果のポーリング監視を開始
function startPollingForResults(sessionId, totalFiles) {
    let lastResultCount = 0;
    let allResults = [];
    
    const pollInterval = setInterval(async () => {
        try {
            const response = await fetch(`/api/dify/session/${sessionId}/status?last_result_count=${lastResultCount}`);
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'Status check failed');
            }
            
            if (data.current_processing) {
                updateCurrentProcessingStatus(data.current_processing);
            }
            
            if (data.new_results && data.new_results.length > 0) {
                allResults = allResults.concat(data.new_results);
                displaySequentialResults(allResults);
                lastResultCount = data.total_results_count;
            }
            
            if (data.completed) {
                clearInterval(pollInterval);
                // ボタンの状態をリセット
                const analyzeBtn = document.getElementById('analyzeBtn');
                const btnText = document.getElementById('btnText');
                const btnSpinner = document.getElementById('btnSpinner');
                
                if (analyzeBtn && btnText && btnSpinner) {
                    analyzeBtn.disabled = false;
                    btnText.textContent = '分析開始';
                    btnSpinner.classList.add('d-none');
                }
                
                checkRetryButtonVisibility(allResults, true);
                
                if (data.errors && data.errors.length > 0) {
                    console.warn('Processing errors:', data.errors);
                }
                
                // 基本情報タブに切り替え
                const basicInfoTab = document.getElementById('basic-info-tab');
                if (basicInfoTab) {
                    const tab = new bootstrap.Tab(basicInfoTab);
                    tab.show();
                    
                    // タブ切り替え後にデータを読み込む
                    setTimeout(() => {
                        loadTableData();
                    }, 100);
                }
            }
            
        } catch (error) {
            clearInterval(pollInterval);
            const errorMessage = 'ステータス確認中にエラーが発生しました';
            displayError(errorMessage);
            console.error('Polling error:', error);
            // ボタンの状態をリセット
            const analyzeBtn = document.getElementById('analyzeBtn');
            const btnText = document.getElementById('btnText');
            const btnSpinner = document.getElementById('btnSpinner');
            
            if (analyzeBtn && btnText && btnSpinner) {
                analyzeBtn.disabled = false;
                btnText.textContent = '分析開始';
                btnSpinner.classList.add('d-none');
            }
        }
    }, 2000);
}

// 逐次処理結果を表示
function displaySequentialResults(results) {
    if (window.resultContent) {
        let html = '';
        results.sort((a, b) => a.file_index - b.file_index);
        results.forEach((item, index) => {
            html += `<div class="mb-3">`;
            html += `<h6>ファイル ${item.file_index + 1}: ${item.filename}</h6>`;
            html += formatResultData(item.result);
            html += `</div>`;
        });
        window.resultContent.innerHTML = html;
    }
    showElement(window.resultArea);
    hideElement(window.errorArea);
    
    updateFileProgress(results);
    
    checkRetryButtonVisibility(results, false);
    
    // 分析結果を保存
    saveAnalysisResults(results);
    
    // 分析結果をローカルストレージにも保存（データ表示ページ用）
    try {
        let displayData = [];
        results.forEach(item => {
            if (item.result && item.result.extracted_data) {
                if (Array.isArray(item.result.extracted_data)) {
                    displayData = displayData.concat(item.result.extracted_data);
                } else {
                    displayData.push(item.result.extracted_data);
                }
            } else if (item.result) {
                displayData.push(item.result);
            } else {
                displayData.push(item);
            }
        });
        
        localStorage.setItem('analysisResults', JSON.stringify(displayData));
        sessionStorage.setItem('analysisResults', JSON.stringify(displayData));
        console.log('分析結果をローカルストレージに保存しました:', displayData);
    } catch (error) {
        console.error('ローカルストレージへの保存に失敗しました:', error);
    }
}

// グローバル変数
let currentSessionId = null;

// リトライボタンのクリックイベント
async function handleRetryFailedClick(event) {
    event.preventDefault();
    
    try {
        hideElement(retryButtonArea);
        
        const response = await fetch(`/api/dify/session/${currentSessionId}/retry-failed`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (!response.ok) {
            throw new Error(result.error || 'Batch retry failed');
        }
        
        console.log('Batch retry started successfully:', result.message);
        
        startPollingForResults(currentSessionId, 0);
        
    } catch (error) {
        console.error('Batch retry error:', error);
        showElement(retryButtonArea);
    }
}

// ボタンのローディング状態を設定
function setButtonLoading(button, isLoading) {
    if (!button) return;
    
    const btnText = button.querySelector('#btnText');
    const btnSpinner = button.querySelector('#btnSpinner');
    
    if (isLoading) {
        button.disabled = true;
        if (btnText) btnText.textContent = '分析中...';
        if (btnSpinner) btnSpinner.classList.remove('d-none');
    } else {
        button.disabled = false;
        if (btnText) btnText.textContent = '分析開始';
        if (btnSpinner) btnSpinner.classList.add('d-none');
    }
}

// エラーを表示
function displayError(error) {
    if (window.errorContent) {
        window.errorContent.textContent = error;
    }
    showElement(window.errorArea);
    hideElement(window.resultArea);
}

// 結果データをフォーマット
function formatResultData(result) {
    if (result && result.extracted_data) {
        return `<pre class="result-content">${JSON.stringify(result.extracted_data, null, 2)}</pre>`;
    } else if (result && result.text) {
        const textContent = result.text;
        if (textContent.includes('```json')) {
            const jsonMatch = textContent.match(/```json\s*\n(.*?)\n```/s);
            if (jsonMatch) {
                try {
                    const parsedData = JSON.parse(jsonMatch[1]);
                    return `<pre class="result-content">${JSON.stringify(parsedData, null, 2)}</pre>`;
                } catch (e) {
                    console.warn('Failed to parse JSON from markdown:', e);
                }
            }
        }
        return `<pre class="result-content">${textContent}</pre>`;
    } else {
        return `<pre class="result-content">${JSON.stringify(result, null, 2)}</pre>`;
    }
}

// 要素を表示/非表示
function showElement(element) {
    if (element) element.classList.remove('d-none');
}

function hideElement(element) {
    if (element) element.classList.add('d-none');
}

// PNGファイルの検証
function isValidPNGFile(file) {
    return file.type === 'image/png' || file.name.toLowerCase().endsWith('.png');
}

// ファイルサイズのフォーマット
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// メッセージを表示
function showMessage(message, type = 'info') {
    // シンプルなアラート表示
    alert(message);
}

// 分析結果を保存
async function saveAnalysisResults(results) {
    try {
        const successfulResults = results.filter(result => !result.failed);
        
        if (successfulResults.length === 0) {
            console.log('保存する分析結果がありません');
            return;
        }
        
        const saveData = successfulResults.map(result => {
            const extractedData = result.result.extracted_data || {};
            return {
                filename: result.filename,
                file_index: result.file_index,
                extracted_data: extractedData,
                completed_at: result.completed_at,
                elapsed_seconds: result.elapsed_seconds
            };
        });
        
        const response = await fetch('/api/analysis/results', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                results: saveData
            })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            console.log('分析結果を保存しました:', result.message);
        } else {
            console.error('分析結果の保存に失敗しました:', result.error);
        }
    } catch (error) {
        console.error('分析結果の保存中にエラーが発生しました:', error);
    }
}

// アップロード結果を表示
function displayUploadResults(results) {
    const uploadResultsArea = document.getElementById('uploadResultsArea');
    const uploadResults = document.getElementById('uploadResults');
    
    if (!uploadResultsArea || !uploadResults) return;
    
    console.log('Displaying upload results:', results);
    
    let html = '<div class="alert alert-success mb-3">分析が完了しました！</div>';
    html += '<div class="table-responsive">';
    html += '<table class="table table-sm">';
    html += '<thead><tr><th>ファイル名</th><th>ステータス</th><th>処理時間</th><th>詳細</th></tr></thead><tbody>';
    
    results.forEach(result => {
        const status = result.failed ? 
            `<span class="badge bg-danger">失敗</span>` : 
            `<span class="badge bg-success">成功</span>`;
        
        const elapsedTime = result.elapsed_seconds ? `${result.elapsed_seconds}秒` : 'N/A';
        
        // 詳細情報を表示
        let details = '';
        if (result.failed) {
            details = `<span class="text-danger">${result.error || 'エラーが発生しました'}</span>`;
        } else if (result.result && result.result.extracted_data) {
            details = `<span class="text-success">データ抽出完了</span>`;
        }
        
        html += `<tr>`;
        html += `<td><strong>${result.filename}</strong></td>`;
        html += `<td>${status}</td>`;
        html += `<td>${elapsedTime}</td>`;
        html += `<td>${details}</td>`;
        html += `</tr>`;
    });
    
    html += '</tbody></table></div>';
    
    // 分析結果の詳細表示
    if (results.some(r => !r.failed && r.result)) {
        html += '<div class="mt-4">';
        html += '<h6>抽出されたデータ:</h6>';
        html += '<div class="table-responsive">';
        html += '<table class="table table-bordered table-sm">';
        html += '<thead class="table-light"><tr><th>ファイル名</th><th>ページ</th><th>出荷日</th><th>受注番号</th><th>納入先番号</th><th>担当者</th><th>税抜合計</th></tr></thead><tbody>';
        
        results.forEach(result => {
            if (!result.failed && result.result && result.result.extracted_data) {
                const data = result.result.extracted_data;
                if (Array.isArray(data)) {
                    data.forEach(item => {
                        html += '<tr>';
                        html += `<td>${result.filename}</td>`;
                        html += `<td>${item.ページ || 'N/A'}</td>`;
                        html += `<td>${item.出荷日 || 'N/A'}</td>`;
                        html += `<td>${item.受注番号 || 'N/A'}</td>`;
                        html += `<td>${item.納入先番号 || 'N/A'}</td>`;
                        html += `<td>${item.担当者 || 'N/A'}</td>`;
                        html += `<td>${addCommas(item.税抜合計) || 'N/A'}</td>`;
                        html += '</tr>';
                    });
                } else if (typeof data === 'object') {
                    html += '<tr>';
                    html += `<td>${result.filename}</td>`;
                    html += `<td>${data.ページ || 'N/A'}</td>`;
                    html += `<td>${data.出荷日 || 'N/A'}</td>`;
                    html += `<td>${data.受注番号 || 'N/A'}</td>`;
                    html += `<td>${data.納入先番号 || 'N/A'}</td>`;
                    html += `<td>${item.担当者 || 'N/A'}</td>`;
                    html += `<td>${addCommas(data.税抜合計) || 'N/A'}</td>`;
                    html += '</tr>';
                }
            }
        });
        
        html += '</tbody></table></div>';
        html += '</div>';
    }
    
    uploadResults.innerHTML = html;
    uploadResultsArea.style.display = 'block';
}

// ページ読み込み完了後の初期化
document.addEventListener('DOMContentLoaded', function() {
    // リトライボタンのイベントリスナーを追加
    const retryFailedBtn = document.getElementById('retryFailedBtn');
    if (retryFailedBtn) {
        retryFailedBtn.addEventListener('click', handleRetryFailedClick);
    }
    
    // ファイル選択時の処理
    const fileInput = document.getElementById('fileInput');
    
    if (fileInput) {
        fileInput.addEventListener('change', (e) => {
            const files = e.target.files;
            if (files.length > 0) {
                let validFiles = 0;
                let totalSize = 0;
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    if (!isValidPNGFile(file)) {
                        continue;
                    }
                    
                    if (file.size > 16 * 1024 * 1024) {
                        continue;
                    }
                    
                    validFiles++;
                    totalSize += file.size;
                }
                
                if (validFiles === 0) {
                    fileInput.value = '';
                    return;
                }
                
                // 常に進捗表示エリアを表示
                displayFileList(files);
            }
        });
    }
});

</script>
{% endblock %}
