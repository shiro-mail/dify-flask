{% extends "base.html" %}

{% block title %}ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º - Dify-FLASK{% endblock %}

{% block content %}
<!-- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒˆãƒ«ãƒãƒ¼ -->
<div class="bg-dark text-white py-3 mb-4">
    <div class="container">
        <h1 class="h3 mb-0">ä»•å…¥ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  Ver2.0</h1>
    </div>
</div>

<div class="container">
    <!-- Bootstrapã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div class="row mb-4">
        <div class="col-12">
            <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="file-import-tab" data-bs-toggle="tab" data-bs-target="#file-import" type="button" role="tab" aria-controls="file-import" aria-selected="true">ãƒ•ã‚¡ã‚¤ãƒ«å–è¾¼</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="basic-info-tab" data-bs-toggle="tab" data-bs-target="#basic-info" type="button" role="tab" aria-controls="basic-info" aria-selected="false">åŸºæœ¬æƒ…å ±</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="inventory-list-tab" data-bs-toggle="tab" data-bs-target="#inventory-list" type="button" role="tab" aria-controls="inventory-list" aria-selected="false">ä»•å…¥ä¸€è¦§</button>
                </li>
            </ul>
        </div>
    </div>

    <!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div class="tab-content" id="myTabContent">
        <!-- ãƒ•ã‚¡ã‚¤ãƒ«å–è¾¼ã‚¿ãƒ– -->
        <div class="tab-pane fade show active" id="file-import" role="tabpanel" aria-labelledby="file-import-tab">
            <div class="row mb-3">
                <div class="col-12">
                    <h2 class="h4">ãƒ•ã‚¡ã‚¤ãƒ«å–è¾¼</h2>
                </div>
            </div>
            
            <!-- ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ</h5>
                        </div>
                        <div class="card-body">
                            <form id="uploadForm" enctype="multipart/form-data">
                                <div class="mb-3">
                                    <label for="fileInput" class="form-label">PNGç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆè¤‡æ•°é¸æŠå¯èƒ½ï¼‰</label>
                                    <input type="file" class="form-control" id="fileInput" name="files" accept=".png" multiple required>
                                    <div class="form-text">å¯¾å¿œå½¢å¼: PNGç”»åƒã®ã¿ï¼ˆå„ãƒ•ã‚¡ã‚¤ãƒ«æœ€å¤§16MBã€è¤‡æ•°é¸æŠå¯èƒ½ï¼‰</div>
                                </div>
                                
                                <div class="text-center">
                                    <button type="submit" class="btn btn-primary btn-lg" id="analyzeBtn">
                                        <span id="btnText">åˆ†æé–‹å§‹</span>
                                        <span id="btnSpinner" class="spinner-border spinner-border-sm d-none ms-2" role="status"></span>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- å˜ä¸€ãƒªãƒˆãƒ©ã‚¤ãƒœã‚¿ãƒ³ï¼ˆå…¨åˆ†æå®Œäº†å¾Œã€å¤±æ•—ãŒã‚ã‚‹å ´åˆã®ã¿è¡¨ç¤ºï¼‰ -->
            <div id="retryButtonArea" class="mb-3 text-center d-none">
                <button type="button" class="btn btn-warning" id="retryFailedBtn">
                    <i class="fas fa-redo"></i> å¤±æ•—ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒªãƒˆãƒ©ã‚¤
                </button>
            </div>
            
            <!-- ãƒ•ã‚¡ã‚¤ãƒ«é€²æ—è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div id="fileProgressArea" class="mt-3 d-none">
                <div class="card">
                    <div class="card-header py-2">
                        <h6 class="mb-0">é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«</h6>
                    </div>
                    <div class="card-body py-2">
                        <div id="fileProgressList" class="list-group list-group-flush">
                            <!-- ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div id="resultArea" class="mt-4 d-none">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">åˆ†æçµæœ</h5>
                    </div>
                    <div class="card-body">
                        <div id="resultContent"></div>
                    </div>
                </div>
            </div>
            
            <!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div id="errorArea" class="mt-4 d-none">
                <div class="alert alert-danger" role="alert">
                    <h6>ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h6>
                    <div id="errorContent"></div>
                </div>
            </div>

        </div>

        <!-- åŸºæœ¬æƒ…å ±ã‚¿ãƒ– -->
        <div class="tab-pane fade" id="basic-info" role="tabpanel" aria-labelledby="basic-info-tab">
            <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒˆãƒ« -->
            <div class="row mb-3">
                <div class="col-12">
                    <h2 class="h4">åŸºæœ¬æƒ…å ±ä¸€è¦§</h2>
                </div>
            </div>

            <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-success" onclick="saveSelectedData()">é¸æŠãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜</button>
                        <button type="button" class="btn btn-danger" onclick="deleteAllData()">å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
                    </div>
                </div>
            </div>

            <!-- ãƒ†ãƒ¼ãƒ–ãƒ«å½¢å¼ã§ã®ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">ãƒ‡ãƒ¼ã‚¿ä¸€è¦§</h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover mb-0">
                                    <thead class="bg-dark text-white">
                                        <tr>
                                            <th style="width: 40px;">
                                                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" checked>
                                            </th>
                                            <th style="width: 60px;">ãƒšãƒ¼ã‚¸</th>
                                            <th style="width: 100px;">å‡ºè·æ—¥</th>
                                            <th style="width: 120px;">å—æ³¨ç•ªå·</th>
                                            <th style="width: 140px;">ç´å…¥å…ˆç•ªå·</th>
                                            <th style="width: 100px;">æ‹…å½“è€…</th>
                                            <th style="width: 120px;">ç¨æŠœåˆè¨ˆ</th>
                                            <th style="width: 120px;">æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tableBody">
                                        <!-- ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿ã¯JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šJSONãƒ‡ãƒ¼ã‚¿è¡¨ç¤º -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šåˆ†æçµæœãƒ‡ãƒ¼ã‚¿</h5>
                        </div>
                        <div class="card-body">
                            <div id="debugDataArea">
                                <!-- JSONãƒ‡ãƒ¼ã‚¿ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä»•å…¥ä¸€è¦§ã‚¿ãƒ– -->
        <div class="tab-pane fade" id="inventory-list" role="tabpanel" aria-labelledby="inventory-list-tab">
            <div class="row mb-3">
                <div class="col-12">
                    <h2 class="h4">ä»•å…¥ä¸€è¦§</h2>
                    <p class="text-muted">ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã®ä¸€è¦§ã‚’è¡¨ç¤ºã—ã¾ã™</p>
                </div>
            </div>
            
            <!-- ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã®ãƒ†ãƒ¼ãƒ–ãƒ« -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">ä¿å­˜æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ä¸€è¦§</h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover mb-0">
                                    <thead class="bg-dark text-white">
                                        <tr>
                                            <th style="width: 60px;">ãƒšãƒ¼ã‚¸</th>
                                            <th style="width: 100px;">å‡ºè·æ—¥</th>
                                            <th style="width: 120px;">å—æ³¨ç•ªå·</th>
                                            <th style="width: 140px;">ç´å…¥å…ˆç•ªå·</th>
                                            <th style="width: 100px;">æ‹…å½“è€…</th>
                                            <th style="width: 120px;">ç¨æŠœåˆè¨ˆ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="savedDataTableBody">
                                        <!-- ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<!-- å‰Šé™¤ç¢ºèªç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmModalLabel">å‰Šé™¤ç¢ºèª</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="deleteConfirmMessage">ã“ã®è¡Œã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn" onclick="confirmDelete()">å‰Šé™¤</button>
            </div>
        </div>
    </div>
</div>

<!-- å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ç¢ºèªç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="deleteAllConfirmModal" tabindex="-1" aria-labelledby="deleteAllConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteAllConfirmModalLabel">å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ç¢ºèª</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteAllData()">å…¨å‰Šé™¤</button>
            </div>
        </div>
    </div>
</div>

<!-- ãƒ‡ãƒ¼ã‚¿è¿½åŠ ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="addDataModal" tabindex="-1" aria-labelledby="addDataModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addDataModalLabel">ãƒ‡ãƒ¼ã‚¿è¿½åŠ </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addDataForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="addPage" class="form-label">ãƒšãƒ¼ã‚¸</label>
                                <input type="text" class="form-control" id="addPage" name="ãƒšãƒ¼ã‚¸" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="addShippingDate" class="form-label">å‡ºè·æ—¥</label>
                                <input type="text" class="form-control" id="addShippingDate" name="å‡ºè·æ—¥" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="addOrderNumber" class="form-label">å—æ³¨ç•ªå·</label>
                                <input type="text" class="form-control" id="addOrderNumber" name="å—æ³¨ç•ªå·" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="addDeliveryNumber" class="form-label">ç´å…¥å…ˆç•ªå·</label>
                                <input type="text" class="form-control" id="addDeliveryNumber" name="ç´å…¥å…ˆç•ªå·" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="addResponsiblePerson" class="form-label">æ‹…å½“è€…</label>
                                <input type="text" class="form-control" id="addResponsiblePerson" name="æ‹…å½“è€…" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="addTotalAmount" class="form-label">ç¨æŠœåˆè¨ˆ</label>
                                <input type="text" class="form-control" id="addTotalAmount" name="ç¨æŠœåˆè¨ˆ" required>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" class="btn btn-success" onclick="confirmAddData()">è¿½åŠ </button>
            </div>
        </div>
    </div>
</div>

<!-- ç·¨é›†ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">ãƒ‡ãƒ¼ã‚¿ç·¨é›†</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editPage" class="form-label">ãƒšãƒ¼ã‚¸</label>
                                <input type="text" class="form-control" id="editPage" name="ãƒšãƒ¼ã‚¸">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editShippingDate" class="form-label">å‡ºè·æ—¥</label>
                                <input type="text" class="form-control" id="editShippingDate" name="å‡ºè·æ—¥">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editOrderNumber" class="form-label">å—æ³¨ç•ªå·</label>
                                <input type="text" class="form-control" id="editOrderNumber" name="å—æ³¨ç•ªå·">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editDeliveryNumber" class="form-label">ç´å…¥å…ˆç•ªå·</label>
                                <input type="text" class="form-control" id="editDeliveryNumber" name="ç´å…¥å…ˆç•ªå·">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editResponsiblePerson" class="form-label">æ‹…å½“è€…</label>
                                <input type="text" class="form-control" id="editResponsiblePerson" name="æ‹…å½“è€…">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editTotalAmount" class="form-label">ç¨æŠœåˆè¨ˆ</label>
                                <input type="text" class="form-control" id="editTotalAmount" name="ç¨æŠœåˆè¨ˆ">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" class="btn btn-primary" onclick="saveEdit()">ä¿å­˜</button>
            </div>
        </div>
    </div>
</div>

<script>
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç®¡ç†
let currentData = [];
let currentEditIndex = -1;

// ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šJSONãƒ‡ãƒ¼ã‚¿ã‚’ãã®ã¾ã¾è¡¨ç¤ºã™ã‚‹æ©Ÿèƒ½
function loadTableData() {
    try {
        // ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã§è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹åˆ†æçµæœã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¾ãŸã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å–å¾—ã‚’è©¦è¡Œ
        let analysisData = null;
        
                    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å–å¾—ã‚’è©¦è¡Œ
            const localData = localStorage.getItem('analysisResults');
            if (localData) {
                analysisData = JSON.parse(localData);
            }
            
            // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å–å¾—ã‚’è©¦è¡Œ
            if (!analysisData) {
                const sessionData = sessionStorage.getItem('analysisResults');
                if (sessionData) {
                    analysisData = JSON.parse(sessionData);
                }
            }
        
        if (analysisData && analysisData.length > 0) {
            console.log('å–å¾—ã—ãŸåˆ†æãƒ‡ãƒ¼ã‚¿:', analysisData);
            console.log('ãƒ‡ãƒ¼ã‚¿ã®é•·ã•:', analysisData.length);
            
            // textãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‹ã‚‰JSONãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºã—ã¦ãƒ‘ãƒ¼ã‚¹
            let actualData = [];
            try {
                // ã™ã¹ã¦ã®analysisDataã®textãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å‡¦ç†
                analysisData.forEach((item, index) => {
                    if (item && item.text) {
                        // textãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‹ã‚‰JSONéƒ¨åˆ†ã‚’æŠ½å‡º
                        const jsonMatch = item.text.match(/```json\s*\n(.*?)\n```/s);
                        if (jsonMatch) {
                            const parsedData = JSON.parse(jsonMatch[1]);
                            // ãƒ‘ãƒ¼ã‚¹ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒé…åˆ—ã®å ´åˆã¯å±•é–‹ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã¯é…åˆ—ã«è¿½åŠ 
                            if (Array.isArray(parsedData)) {
                                actualData = actualData.concat(parsedData);
                            } else {
                                actualData.push(parsedData);
                            }
                        }
                    }
                });
                
                console.log('ãƒ‘ãƒ¼ã‚¹ã•ã‚ŒãŸå®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿:', actualData);
                console.log('å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã®é•·ã•:', actualData.length);
            } catch (parseError) {
                console.error('JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', parseError);
            }
            
            // å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
            const debugArea = document.getElementById('debugDataArea');
            if (debugArea) {
                if (actualData.length > 0) {
                    debugArea.innerHTML = `
                        <h6>ãƒ‘ãƒ¼ã‚¹ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ï¼ˆ${actualData.length}ä»¶ï¼‰:</h6>
                        <pre>${JSON.stringify(actualData, null, 2)}</pre>
                    `;
                    
                    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
                    currentData = actualData;
                    
                    // ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã‚‚ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
                    displayTableData(actualData);
                } else {
                    debugArea.innerHTML = `
                        <h6>å…ƒã®ãƒ‡ãƒ¼ã‚¿:</h6>
                        <pre>${JSON.stringify(analysisData, null, 2)}</pre>
                    `;
                }
            }
        } else {
            // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆ
            console.log('åˆ†æãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            const debugArea = document.getElementById('debugDataArea');
            if (debugArea) {
                debugArea.innerHTML = '<p>åˆ†æãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>';
            }
        }
    } catch (error) {
        console.error('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
        const debugArea = document.getElementById('debugDataArea');
        if (debugArea) {
            debugArea.innerHTML = `<p>ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}</p>`;
        }
    }
}

// é‡‘é¡ã«ã‚«ãƒ³ãƒã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
function addCommas(value) {
    if (typeof value === 'string' && value !== 'N/A') {
        // æ—¢å­˜ã®ã‚«ãƒ³ãƒã‚’é™¤å»ã—ã¦ã‹ã‚‰æ•°å€¤ã¨ã—ã¦å‡¦ç†
        const numValue = value.replace(/,/g, '');
        if (!isNaN(numValue)) {
            return parseInt(numValue).toLocaleString();
        }
    }
    return value;
}

// ãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
function displayTableData(data) {
    const tableBody = document.getElementById('tableBody');
    if (!tableBody) return;
    
    let html = '';
    
    data.forEach((item, index) => {
        html += '<tr>';
        html += `<td><input type="checkbox" class="row-checkbox" value="${index}" onchange="updateSelectAllState()" checked></td>`;
        html += `<td>${item.ãƒšãƒ¼ã‚¸ || 'N/A'}</td>`;
        html += `<td>${item.å‡ºè·æ—¥ || 'N/A'}</td>`;
        html += `<td>${item.å—æ³¨ç•ªå· || 'N/A'}</td>`;
        html += `<td>${item.ç´å…¥å…ˆç•ªå· || 'N/A'}</td>`;
        html += `<td>${item.æ‹…å½“è€… || 'N/A'}</td>`;
        html += `<td>${addCommas(item.ç¨æŠœåˆè¨ˆ) || 'N/A'}</td>`;
        html += '<td>';
        html += '<div class="d-flex gap-1">';
        html += `<button type="button" class="btn btn-warning btn-sm" onclick="editRow(${index})">ç·¨é›†</button>`;
        html += `<button type="button" class="btn btn-danger btn-sm" onclick="deleteRow(${index})">å‰Šé™¤</button>`;
        html += `<button type="button" class="btn btn-success btn-sm" onclick="addRow(${index})">è¿½åŠ </button>`;
        html += '</div>';
        html += '</td>';
        html += '</tr>';
    });
    
    tableBody.innerHTML = html;
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼šç¾åœ¨ç·¨é›†ä¸­ã®ãƒ‡ãƒ¼ã‚¿
currentEditIndex = -1;
currentData = [];

// ç·¨é›†ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†
function editRow(index) {
    if (index >= 0 && index < currentData.length) {
        currentEditIndex = index;
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
        const item = currentData[index];
        document.getElementById('editPage').value = item.ãƒšãƒ¼ã‚¸ || '';
        document.getElementById('editShippingDate').value = item.å‡ºè·æ—¥ || '';
        document.getElementById('editOrderNumber').value = item.å—æ³¨ç•ªå· || '';
        document.getElementById('editDeliveryNumber').value = item.ç´å…¥å…ˆç•ªå· || '';
        document.getElementById('editResponsiblePerson').value = item.æ‹…å½“è€… || '';
        // ç¨æŠœåˆè¨ˆã¯ã‚«ãƒ³ãƒã‚’é™¤å»ã—ã¦è¡¨ç¤º
        document.getElementById('editTotalAmount').value = (item.ç¨æŠœåˆè¨ˆ || '').replace(/,/g, '');
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        const editModal = new bootstrap.Modal(document.getElementById('editModal'));
        editModal.show();
    }
}

// ä¿å­˜ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†
function saveEdit() {
    if (currentEditIndex === -1) return;
    
    // ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰å€¤ã‚’å–å¾—
    const updatedItem = {
        ãƒšãƒ¼ã‚¸: document.getElementById('editPage').value,
        å‡ºè·æ—¥: document.getElementById('editShippingDate').value,
        å—æ³¨ç•ªå·: document.getElementById('editOrderNumber').value,
        ç´å…¥å…ˆç•ªå·: document.getElementById('editDeliveryNumber').value,
        æ‹…å½“è€…: document.getElementById('editResponsiblePerson').value,
        ç¨æŠœåˆè¨ˆ: document.getElementById('editTotalAmount').value
    };
    
    // ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
    currentData[currentEditIndex] = { ...currentData[currentEditIndex], ...updatedItem };
    
    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’æ›´æ–°
    const sessionData = sessionStorage.getItem('analysisResults');
    if (sessionData) {
        const analysisData = JSON.parse(sessionData);
        if (analysisData[0] && analysisData[0].text) {
            // æ›´æ–°ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã§textãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å†æ§‹ç¯‰
            const updatedText = analysisData[0].text.replace(
                /```json\s*\n.*?\n```/s,
                `\`\`\`json\n${JSON.stringify(currentData, null, 2)}\n\`\`\``
            );
            analysisData[0].text = updatedText;
            
            // æ›´æ–°ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            sessionStorage.setItem('analysisResults', JSON.stringify(analysisData));
            localStorage.setItem('analysisResults', JSON.stringify(analysisData));
        }
    }
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å†è¡¨ç¤º
    displayTableData(currentData);
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    const editModal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
    editModal.hide();
    

}

// å‰Šé™¤ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†
function deleteRow(index) {
    // å—æ³¨ç•ªå·ã‚’å–å¾—ã—ã¦ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨­å®š
    const item = currentData[index];
    const orderNumber = item.å—æ³¨ç•ªå· || 'N/A';
    
    // ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–°
    document.getElementById('deleteConfirmMessage').innerHTML = 
        `å—æ³¨ç•ªå·ï¼š<strong>${orderNumber}</strong><br>ã“ã®è¡Œã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`;
    
    // å‰Šé™¤å¯¾è±¡ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä¿å­˜
    window.deleteTargetIndex = index;
    
    // å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    deleteModal.show();
}

// å‰Šé™¤ç¢ºèªå¾Œã®å®Ÿéš›ã®å‰Šé™¤å‡¦ç†
function confirmDelete() {
    const index = window.deleteTargetIndex;
    if (index !== undefined) {
        // æŒ‡å®šã•ã‚ŒãŸè¡Œã‚’å‰Šé™¤ï¼ˆcurrentDataã‹ã‚‰ç›´æ¥å‰Šé™¤ï¼‰
        currentData.splice(index, 1);
        
        // ãƒ‡ãƒ¼ã‚¿ãŒæ®‹ã£ã¦ã„ã‚‹å ´åˆã¯æ›´æ–°ã€ç©ºã«ãªã£ãŸå ´åˆã¯å®Œå…¨å‰Šé™¤
        if (currentData.length > 0) {
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’æ›´æ–°
            const sessionData = sessionStorage.getItem('analysisResults');
            if (sessionData) {
                const analysisData = JSON.parse(sessionData);
                if (analysisData[0] && analysisData[0].text) {
                    // æ›´æ–°ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã§textãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å†æ§‹ç¯‰
                    const updatedText = analysisData[0].text.replace(
                        /```json\s*\n.*?\n```/s,
                        `\`\`\`json\n${JSON.stringify(currentData, null, 2)}\n\`\`\``
                    );
                    analysisData[0].text = updatedText;
                    
                    // æ›´æ–°ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                    sessionStorage.setItem('analysisResults', JSON.stringify(analysisData));
                    localStorage.setItem('analysisResults', JSON.stringify(analysisData));
                }
            }
        } else {
            // ãƒ‡ãƒ¼ã‚¿ãŒç©ºã«ãªã£ãŸå ´åˆã¯å®Œå…¨ã«å‰Šé™¤
            localStorage.removeItem('analysisResults');
            sessionStorage.removeItem('analysisResults');
        }
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å†è¡¨ç¤º
        displayTableData(currentData);
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
        deleteModal.hide();
        
        // å‰Šé™¤å¯¾è±¡ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ã‚¯ãƒªã‚¢
        window.deleteTargetIndex = undefined;
    }
}

// è¿½åŠ ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†
function addRow(index) {
    // è¿½åŠ å¯¾è±¡ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä¿å­˜ï¼ˆæ¬¡ã®è¡Œã«æŒ¿å…¥ã™ã‚‹ãŸã‚+1ï¼‰
    window.addTargetIndex = index + 1;
    
    // ã‚¯ãƒªãƒƒã‚¯ã—ãŸè¡Œã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const sourceItem = currentData[index];
    
    // ãƒ•ã‚©ãƒ¼ãƒ ã«åˆæœŸå€¤ã¨ã—ã¦ã‚³ãƒ”ãƒ¼ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
    document.getElementById('addPage').value = sourceItem.ãƒšãƒ¼ã‚¸ || '';
    document.getElementById('addShippingDate').value = sourceItem.å‡ºè·æ—¥ || '';
    document.getElementById('addOrderNumber').value = sourceItem.å—æ³¨ç•ªå· || '';
    document.getElementById('addDeliveryNumber').value = sourceItem.ç´å…¥å…ˆç•ªå· || '';
    document.getElementById('addResponsiblePerson').value = sourceItem.æ‹…å½“è€… || '';
    // ç¨æŠœåˆè¨ˆã¯ã‚«ãƒ³ãƒã‚’é™¤å»ã—ã¦è¡¨ç¤º
    document.getElementById('addTotalAmount').value = (sourceItem.ç¨æŠœåˆè¨ˆ || '').replace(/,/g, '');
    
    // ãƒ‡ãƒ¼ã‚¿è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    const addModal = new bootstrap.Modal(document.getElementById('addDataModal'));
    addModal.show();
}

// ãƒ‡ãƒ¼ã‚¿è¿½åŠ ç¢ºèªå¾Œã®å®Ÿéš›ã®è¿½åŠ å‡¦ç†
function confirmAddData() {
    const index = window.addTargetIndex;
    if (index !== undefined) {
        // ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰å€¤ã‚’å–å¾—
        const newItem = {
            ãƒšãƒ¼ã‚¸: document.getElementById('addPage').value,
            å‡ºè·æ—¥: document.getElementById('addShippingDate').value,
            å—æ³¨ç•ªå·: document.getElementById('addOrderNumber').value,
            ç´å…¥å…ˆç•ªå·: document.getElementById('addDeliveryNumber').value,
            æ‹…å½“è€…: document.getElementById('addResponsiblePerson').value,
            ç¨æŠœåˆè¨ˆ: document.getElementById('addTotalAmount').value
        };
        
        // æŒ‡å®šã•ã‚ŒãŸä½ç½®ã«æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’æŒ¿å…¥
        currentData.splice(index, 0, newItem);
        
        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’æ›´æ–°
        const sessionData = sessionStorage.getItem('analysisResults');
        if (sessionData) {
            const analysisData = JSON.parse(sessionData);
            if (analysisData[0] && analysisData[0].text) {
                // æ›´æ–°ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã§textãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å†æ§‹ç¯‰
                const updatedText = analysisData[0].text.replace(
                    /```json\s*\n.*?\n```/s,
                    `\`\`\`json\n${JSON.stringify(currentData, null, 2)}\n\`\`\``
                );
                analysisData[0].text = updatedText;
                
                // æ›´æ–°ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                sessionStorage.setItem('analysisResults', JSON.stringify(analysisData));
                localStorage.setItem('analysisResults', JSON.stringify(analysisData));
            }
        }
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å†è¡¨ç¤º
        displayTableData(currentData);
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        const addModal = bootstrap.Modal.getInstance(document.getElementById('addDataModal'));
        addModal.hide();
        
        // è¿½åŠ å¯¾è±¡ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ã‚¯ãƒªã‚¢
        window.addTargetIndex = undefined;
    }
}

// å…¨é¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆ
function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAll');
    const rowCheckboxes = document.querySelectorAll('.row-checkbox');
    
    rowCheckboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });
}

// å€‹åˆ¥ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã«åŸºã¥ã„ã¦å…¨é¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’æ›´æ–°
function updateSelectAllState() {
    const selectAllCheckbox = document.getElementById('selectAll');
    const rowCheckboxes = document.querySelectorAll('.row-checkbox');
    const checkedCount = document.querySelectorAll('.row-checkbox:checked').length;
    
    if (checkedCount === 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
    } else if (checkedCount === rowCheckboxes.length) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
    } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
    }
}

// é¸æŠã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
function saveSelectedData() {
    const selectedCheckboxes = document.querySelectorAll('.row-checkbox:checked');
    
    if (selectedCheckboxes.length === 0) {
        alert('ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
        return;
    }
    
    // é¸æŠã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const selectedData = [];
    selectedCheckboxes.forEach(checkbox => {
        const index = parseInt(checkbox.value);
        if (index >= 0 && index < currentData.length) {
            selectedData.push(currentData[index]);
        }
    });
    
    // ã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜
    fetch('/api/analysis/results', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            results: selectedData
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`é¸æŠã•ã‚ŒãŸ${selectedData.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚`);
            
            // ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’currentDataã‹ã‚‰å‰Šé™¤
            // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒãšã‚Œãªã„ã‚ˆã†ã«ã€å¾Œã‚ã‹ã‚‰å‰Šé™¤
            const sortedIndices = Array.from(selectedCheckboxes)
                .map(checkbox => parseInt(checkbox.value))
                .sort((a, b) => b - a); // é™é †ã§ã‚½ãƒ¼ãƒˆ
            
            sortedIndices.forEach(index => {
                if (index >= 0 && index < currentData.length) {
                    currentData.splice(index, 1);
                }
            });
            
            // æ›´æ–°ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã§ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å†è¡¨ç¤º
            displayTableData(currentData);
            
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’æ›´æ–°
            if (currentData.length > 0) {
                // æ®‹ã‚Šã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯æ›´æ–°
                const sessionData = sessionStorage.getItem('analysisResults');
                if (sessionData) {
                    const analysisData = JSON.parse(sessionData);
                    if (analysisData[0] && analysisData[0].text) {
                        // æ›´æ–°ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã§textãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å†æ§‹ç¯‰
                        const updatedText = analysisData[0].text.replace(
                            /```json\s*\n.*?\n```/s,
                            `\`\`\`json\n${JSON.stringify(currentData, null, 2)}\n\`\`\``
                        );
                        analysisData[0].text = updatedText;
                        
                        // æ›´æ–°ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                        sessionStorage.setItem('analysisResults', JSON.stringify(analysisData));
                        localStorage.setItem('analysisResults', JSON.stringify(analysisData));
                    }
                }
            } else {
                // ãƒ‡ãƒ¼ã‚¿ãŒç©ºã«ãªã£ãŸå ´åˆã¯å®Œå…¨ã«å‰Šé™¤
                localStorage.removeItem('analysisResults');
                sessionStorage.removeItem('analysisResults');
            }
            
            // ãƒ‡ãƒãƒƒã‚°ã‚¨ãƒªã‚¢ã‚‚æ›´æ–°
            const debugArea = document.getElementById('debugDataArea');
            if (debugArea) {
                if (currentData.length > 0) {
                    debugArea.innerHTML = `
                        <h6>ãƒ‘ãƒ¼ã‚¹ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ï¼ˆ${currentData.length}ä»¶ï¼‰:</h6>
                        <pre>${JSON.stringify(currentData, null, 2)}</pre>
                    `;
                } else {
                    debugArea.innerHTML = '<p>ãƒ‡ãƒ¼ã‚¿ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸ</p>';
                }
            }
            
            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ã‚¯ãƒªã‚¢
            document.querySelectorAll('.row-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            document.getElementById('selectAll').checked = false;
            document.getElementById('selectAll').indeterminate = false;
        } else {
            alert('ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.error);
        }
    })
    .catch(error => {
        console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
    });
}

// å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†
function deleteAllData() {
    // å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    const deleteAllModal = new bootstrap.Modal(document.getElementById('deleteAllConfirmModal'));
    deleteAllModal.show();
}

// å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ç¢ºèªå¾Œã®å®Ÿéš›ã®å‰Šé™¤å‡¦ç†
function confirmDeleteAllData() {
    // currentDataã‚’ç©ºã«ã™ã‚‹
    currentData = [];
    
    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å®Œå…¨ã«å‰Šé™¤
    localStorage.removeItem('analysisResults');
    sessionStorage.removeItem('analysisResults');
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å†è¡¨ç¤ºï¼ˆç©ºã®ãƒ‡ãƒ¼ã‚¿ï¼‰
    displayTableData(currentData);
    
    // ãƒ‡ãƒãƒƒã‚°ã‚¨ãƒªã‚¢ã‚‚æ›´æ–°
    const debugArea = document.getElementById('debugDataArea');
    if (debugArea) {
        debugArea.innerHTML = '<p>ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ</p>';
    }
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    const deleteAllModal = bootstrap.Modal.getInstance(document.getElementById('deleteAllConfirmModal'));
    deleteAllModal.hide();
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
document.addEventListener('DOMContentLoaded', function() {
    loadTableData();
    
    // ã‚¿ãƒ–ã®åˆ‡ã‚Šæ›¿ãˆã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
    const inventoryListTab = document.getElementById('inventory-list-tab');
    if (inventoryListTab) {
        inventoryListTab.addEventListener('click', function() {
            loadSavedData();
        });
    }
});

// ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§è¡¨ç¤º
function loadSavedData() {
    fetch('/api/analysis/results', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displaySavedData(data.results);
        } else {
            console.error('ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', data.error);
            displaySavedData([]);
        }
    })
    .catch(error => {
        console.error('ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        displaySavedData([]);
    });
}

// ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¡¨ç¤ºï¼ˆæ“ä½œãƒœã‚¿ãƒ³ãªã—ï¼‰
function displaySavedData(data) {
    const tableBody = document.getElementById('savedDataTableBody');
    if (!tableBody) return;
    
    let html = '';
    
    if (data.length === 0) {
        html = '<tr><td colspan="6" class="text-center text-muted">ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
    } else {
        data.forEach((item, index) => {
            html += '<tr>';
            html += `<td>${item.ãƒšãƒ¼ã‚¸ || 'N/A'}</td>`;
            html += `<td>${item.å‡ºè·æ—¥ || 'N/A'}</td>`;
            html += `<td>${item.å—æ³¨ç•ªå· || 'N/A'}</td>`;
            html += `<td>${item.ç´å…¥å…ˆç•ªå· || 'N/A'}</td>`;
            html += `<td>${item.æ‹…å½“è€… || 'N/A'}</td>`;
            html += `<td>${addCommas(item.ç¨æŠœåˆè¨ˆ) || 'N/A'}</td>`;
            html += '</tr>';
        });
    }
    
    tableBody.innerHTML = html;
}

// ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒ ã®å‡¦ç†
document.addEventListener('DOMContentLoaded', function() {
    const uploadForm = document.getElementById('uploadForm');
    if (uploadForm) {
        uploadForm.addEventListener('submit', handleFileUpload);
    }
    
    // å¿…è¦ãªè¦ç´ ã®å‚ç…§ã‚’å–å¾—
    window.fileProgressList = document.getElementById('fileProgressList');
    window.fileProgressArea = document.getElementById('fileProgressArea');
    window.retryButtonArea = document.getElementById('retryButtonArea');
    window.retryFailedBtn = document.getElementById('retryFailedBtn');
    window.resultContent = document.getElementById('resultContent');
    window.resultArea = document.getElementById('resultArea');
    window.errorArea = document.getElementById('errorArea');
    window.errorContent = document.getElementById('errorContent');
});

// ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
function handleFileUpload(event) {
    event.preventDefault();
    
    const fileInput = document.getElementById('fileInput');
    const files = fileInput.files;
    
    if (files.length === 0) {
        alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
        return;
    }
    
    if (files.length > 10) {
        alert('æœ€å¤§10ãƒ•ã‚¡ã‚¤ãƒ«ã¾ã§é¸æŠã§ãã¾ã™ã€‚');
        return;
    }
    
    // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’å¤‰æ›´
    const analyzeBtn = document.getElementById('analyzeBtn');
    const btnText = document.getElementById('btnText');
    const btnSpinner = document.getElementById('btnSpinner');
    
    analyzeBtn.disabled = true;
    btnText.textContent = 'åˆ†æä¸­...';
    btnSpinner.classList.remove('d-none');
    
    // FormDataã‚’ä½œæˆ
    const formData = new FormData();
    for (let i = 0; i < files.length; i++) {
        formData.append('files', files[i]);
    }
    

    
    // ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
    displayFileList(files);
    
    // ã‚µãƒ¼ãƒãƒ¼ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    fetch('/api/dify/analyze-sequential', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            startPollingForResults(data.session_id, data.total_files);
        } else {
            const errorMessage = data.error || 'å‡¦ç†é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ';
            displayError(errorMessage);
            // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            const analyzeBtn = document.getElementById('analyzeBtn');
            const btnText = document.getElementById('btnText');
            const btnSpinner = document.getElementById('btnSpinner');
            
            if (analyzeBtn && btnText && btnSpinner) {
                analyzeBtn.disabled = false;
                btnText.textContent = 'åˆ†æé–‹å§‹';
                btnSpinner.classList.add('d-none');
            }
        }
    })
    .catch(error => {
        const errorMessage = 'å‡¦ç†é–‹å§‹ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
        displayError(errorMessage);
        console.error('Sequential processing error:', error);
        // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
        const analyzeBtn = document.getElementById('analyzeBtn');
        const btnText = document.getElementById('btnText');
        const btnSpinner = document.getElementById('btnSpinner');
        
        if (analyzeBtn && btnText && btnSpinner) {
            analyzeBtn.disabled = false;
            btnText.textContent = 'åˆ†æé–‹å§‹';
            btnSpinner.classList.add('d-none');
        }
    });
}

// ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
function displayFileList(files) {
    if (!fileProgressList || !fileProgressArea) return;
    
    // å¸¸ã«é€²æ—è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
    let html = '';
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        if (isValidPNGFile(file) && file.size <= 16 * 1024 * 1024) {
            html += `<div class="file-progress-item" data-file-index="${i}">`;
            html += `<span class="file-name">${file.name}</span>`;
            html += `<span class="file-status">â³ å¾…æ©Ÿä¸­</span>`;
            html += `</div>`;
        }
    }
    
    fileProgressList.innerHTML = html;
    showElement(fileProgressArea);
}

// ãƒ•ã‚¡ã‚¤ãƒ«é€²æ—ã‚’æ›´æ–°
function updateFileProgress(results) {
    if (!fileProgressList) return;
    
    results.forEach(result => {
        const fileItem = fileProgressList.querySelector(`[data-file-index="${result.file_index}"]`);
        if (fileItem) {
            const statusElement = fileItem.querySelector('.file-status');
            if (statusElement) {
                const elapsedText = result.elapsed_seconds ? ` (${result.elapsed_seconds}ç§’)` : '';
                const attemptText = result.current_attempt ? ` (${result.current_attempt}å›ç›®)` : '';
                
                if (result.failed) {
                    statusElement.innerHTML = `âŒ å¤±æ•—${attemptText}${elapsedText}`;
                    statusElement.style.color = '#dc3545';
                    fileItem.classList.add('failed');
                    fileItem.classList.remove('completed', 'processing');
                } else {
                    statusElement.innerHTML = `âœ… å®Œäº†${attemptText}${elapsedText}`;
                    statusElement.style.color = '#28a745';
                    fileItem.classList.add('completed');
                    fileItem.classList.remove('failed', 'processing');
                }
            }
        }
    });
}

// ç¾åœ¨å‡¦ç†ä¸­ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®çŠ¶æ…‹ã‚’æ›´æ–°
function updateCurrentProcessingStatus(processingInfo) {
    if (!fileProgressList || !processingInfo) return;
    
    const fileItem = fileProgressList.querySelector(`[data-file-index="${processingInfo.file_index}"]`);
    if (fileItem) {
        const statusElement = fileItem.querySelector('.file-status');
        if (statusElement) {
            const attemptText = `${processingInfo.current_attempt}å›ç›®åˆ†æä¸­`;
            statusElement.innerHTML = `ğŸ”„ ${attemptText}`;
            statusElement.innerHTML = `ğŸ”„ ${attemptText}`;
            statusElement.style.color = '#007bff';
            fileItem.classList.add('processing');
            fileItem.classList.remove('completed', 'failed');
        }
    }
}

// ãƒªãƒˆãƒ©ã‚¤ãƒœã‚¿ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ¶å¾¡
function checkRetryButtonVisibility(allResults, isCompleted) {
    if (!retryButtonArea || !retryFailedBtn) return;
    
    if (isCompleted && allResults.some(result => result.failed)) {
        showElement(retryButtonArea);
    } else {
        hideElement(retryButtonArea);
    }
}

// ã‚»ãƒƒã‚·ãƒ§ãƒ³çµæœã®ãƒãƒ¼ãƒªãƒ³ã‚°ç›£è¦–ã‚’é–‹å§‹
function startPollingForResults(sessionId, totalFiles) {
    let lastResultCount = 0;
    let allResults = [];
    
    const pollInterval = setInterval(async () => {
        try {
            const response = await fetch(`/api/dify/session/${sessionId}/status?last_result_count=${lastResultCount}`);
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'Status check failed');
            }
            
            if (data.current_processing) {
                updateCurrentProcessingStatus(data.current_processing);
            }
            
            if (data.new_results && data.new_results.length > 0) {
                allResults = allResults.concat(data.new_results);
                displaySequentialResults(allResults);
                lastResultCount = data.total_results_count;
            }
            
            if (data.completed) {
                clearInterval(pollInterval);
                // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
                const analyzeBtn = document.getElementById('analyzeBtn');
                const btnText = document.getElementById('btnText');
                const btnSpinner = document.getElementById('btnSpinner');
                
                if (analyzeBtn && btnText && btnSpinner) {
                    analyzeBtn.disabled = false;
                    btnText.textContent = 'åˆ†æé–‹å§‹';
                    btnSpinner.classList.add('d-none');
                }
                
                checkRetryButtonVisibility(allResults, true);
                
                if (data.errors && data.errors.length > 0) {
                    console.warn('Processing errors:', data.errors);
                }
                
                // åŸºæœ¬æƒ…å ±ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆ
                const basicInfoTab = document.getElementById('basic-info-tab');
                if (basicInfoTab) {
                    const tab = new bootstrap.Tab(basicInfoTab);
                    tab.show();
                    
                    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆå¾Œã«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
                    setTimeout(() => {
                        loadTableData();
                    }, 100);
                }
            }
            
        } catch (error) {
            clearInterval(pollInterval);
            const errorMessage = 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
            displayError(errorMessage);
            console.error('Polling error:', error);
            // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            const analyzeBtn = document.getElementById('analyzeBtn');
            const btnText = document.getElementById('btnText');
            const btnSpinner = document.getElementById('btnSpinner');
            
            if (analyzeBtn && btnText && btnSpinner) {
                analyzeBtn.disabled = false;
                btnText.textContent = 'åˆ†æé–‹å§‹';
                btnSpinner.classList.add('d-none');
            }
        }
    }, 2000);
}

// é€æ¬¡å‡¦ç†çµæœã‚’è¡¨ç¤º
function displaySequentialResults(results) {
    if (window.resultContent) {
        let html = '';
        results.sort((a, b) => a.file_index - b.file_index);
        results.forEach((item, index) => {
            html += `<div class="mb-3">`;
            html += `<h6>ãƒ•ã‚¡ã‚¤ãƒ« ${item.file_index + 1}: ${item.filename}</h6>`;
            html += formatResultData(item.result);
            html += `</div>`;
        });
        window.resultContent.innerHTML = html;
    }
    showElement(window.resultArea);
    hideElement(window.errorArea);
    
    updateFileProgress(results);
    
    checkRetryButtonVisibility(results, false);
    
    // åˆ†æçµæœã‚’ä¿å­˜
    saveAnalysisResults(results);
    
    // åˆ†æçµæœã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã‚‚ä¿å­˜ï¼ˆãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºãƒšãƒ¼ã‚¸ç”¨ï¼‰
    try {
        let displayData = [];
        results.forEach(item => {
            if (item.result && item.result.extracted_data) {
                if (Array.isArray(item.result.extracted_data)) {
                    displayData = displayData.concat(item.result.extracted_data);
                } else {
                    displayData.push(item.result.extracted_data);
                }
            } else if (item.result) {
                displayData.push(item.result);
            } else {
                displayData.push(item);
            }
        });
        
        localStorage.setItem('analysisResults', JSON.stringify(displayData));
        sessionStorage.setItem('analysisResults', JSON.stringify(displayData));
        console.log('åˆ†æçµæœã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã—ã¾ã—ãŸ:', displayData);
    } catch (error) {
        console.error('ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
    }
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let currentSessionId = null;

// ãƒªãƒˆãƒ©ã‚¤ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
async function handleRetryFailedClick(event) {
    event.preventDefault();
    
    try {
        hideElement(retryButtonArea);
        
        const response = await fetch(`/api/dify/session/${currentSessionId}/retry-failed`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (!response.ok) {
            throw new Error(result.error || 'Batch retry failed');
        }
        
        console.log('Batch retry started successfully:', result.message);
        
        startPollingForResults(currentSessionId, 0);
        
    } catch (error) {
        console.error('Batch retry error:', error);
        showElement(retryButtonArea);
    }
}

// ãƒœã‚¿ãƒ³ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’è¨­å®š
function setButtonLoading(button, isLoading) {
    if (!button) return;
    
    const btnText = button.querySelector('#btnText');
    const btnSpinner = button.querySelector('#btnSpinner');
    
    if (isLoading) {
        button.disabled = true;
        if (btnText) btnText.textContent = 'åˆ†æä¸­...';
        if (btnSpinner) btnSpinner.classList.remove('d-none');
    } else {
        button.disabled = false;
        if (btnText) btnText.textContent = 'åˆ†æé–‹å§‹';
        if (btnSpinner) btnSpinner.classList.add('d-none');
    }
}

// ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º
function displayError(error) {
    if (window.errorContent) {
        window.errorContent.textContent = error;
    }
    showElement(window.errorArea);
    hideElement(window.resultArea);
}

// çµæœãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
function formatResultData(result) {
    if (result && result.extracted_data) {
        return `<pre class="result-content">${JSON.stringify(result.extracted_data, null, 2)}</pre>`;
    } else if (result && result.text) {
        const textContent = result.text;
        if (textContent.includes('```json')) {
            const jsonMatch = textContent.match(/```json\s*\n(.*?)\n```/s);
            if (jsonMatch) {
                try {
                    const parsedData = JSON.parse(jsonMatch[1]);
                    return `<pre class="result-content">${JSON.stringify(parsedData, null, 2)}</pre>`;
                } catch (e) {
                    console.warn('Failed to parse JSON from markdown:', e);
                }
            }
        }
        return `<pre class="result-content">${textContent}</pre>`;
    } else {
        return `<pre class="result-content">${JSON.stringify(result, null, 2)}</pre>`;
    }
}

// è¦ç´ ã‚’è¡¨ç¤º/éè¡¨ç¤º
function showElement(element) {
    if (element) element.classList.remove('d-none');
}

function hideElement(element) {
    if (element) element.classList.add('d-none');
}

// PNGãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œè¨¼
function isValidPNGFile(file) {
    return file.type === 'image/png' || file.name.toLowerCase().endsWith('.png');
}

// ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
function showMessage(message, type = 'info') {
    // ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
    alert(message);
}

// åˆ†æçµæœã‚’ä¿å­˜
async function saveAnalysisResults(results) {
    try {
        const successfulResults = results.filter(result => !result.failed);
        
        if (successfulResults.length === 0) {
            console.log('ä¿å­˜ã™ã‚‹åˆ†æçµæœãŒã‚ã‚Šã¾ã›ã‚“');
            return;
        }
        
        const saveData = successfulResults.map(result => {
            const extractedData = result.result.extracted_data || {};
            return {
                filename: result.filename,
                file_index: result.file_index,
                extracted_data: extractedData,
                completed_at: result.completed_at,
                elapsed_seconds: result.elapsed_seconds
            };
        });
        
        const response = await fetch('/api/analysis/results', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                results: saveData
            })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            console.log('åˆ†æçµæœã‚’ä¿å­˜ã—ã¾ã—ãŸ:', result.message);
        } else {
            console.error('åˆ†æçµæœã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:', result.error);
        }
    } catch (error) {
        console.error('åˆ†æçµæœã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
    }
}

// ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰çµæœã‚’è¡¨ç¤º
function displayUploadResults(results) {
    const uploadResultsArea = document.getElementById('uploadResultsArea');
    const uploadResults = document.getElementById('uploadResults');
    
    if (!uploadResultsArea || !uploadResults) return;
    
    console.log('Displaying upload results:', results);
    
    let html = '<div class="alert alert-success mb-3">åˆ†æãŒå®Œäº†ã—ã¾ã—ãŸï¼</div>';
    html += '<div class="table-responsive">';
    html += '<table class="table table-sm">';
    html += '<thead><tr><th>ãƒ•ã‚¡ã‚¤ãƒ«å</th><th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th><th>å‡¦ç†æ™‚é–“</th><th>è©³ç´°</th></tr></thead><tbody>';
    
    results.forEach(result => {
        const status = result.failed ? 
            `<span class="badge bg-danger">å¤±æ•—</span>` : 
            `<span class="badge bg-success">æˆåŠŸ</span>`;
        
        const elapsedTime = result.elapsed_seconds ? `${result.elapsed_seconds}ç§’` : 'N/A';
        
        // è©³ç´°æƒ…å ±ã‚’è¡¨ç¤º
        let details = '';
        if (result.failed) {
            details = `<span class="text-danger">${result.error || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'}</span>`;
        } else if (result.result && result.result.extracted_data) {
            details = `<span class="text-success">ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºå®Œäº†</span>`;
        }
        
        html += `<tr>`;
        html += `<td><strong>${result.filename}</strong></td>`;
        html += `<td>${status}</td>`;
        html += `<td>${elapsedTime}</td>`;
        html += `<td>${details}</td>`;
        html += `</tr>`;
    });
    
    html += '</tbody></table></div>';
    
    // åˆ†æçµæœã®è©³ç´°è¡¨ç¤º
    if (results.some(r => !r.failed && r.result)) {
        html += '<div class="mt-4">';
        html += '<h6>æŠ½å‡ºã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿:</h6>';
        html += '<div class="table-responsive">';
        html += '<table class="table table-bordered table-sm">';
        html += '<thead class="table-light"><tr><th>ãƒ•ã‚¡ã‚¤ãƒ«å</th><th>ãƒšãƒ¼ã‚¸</th><th>å‡ºè·æ—¥</th><th>å—æ³¨ç•ªå·</th><th>ç´å…¥å…ˆç•ªå·</th><th>æ‹…å½“è€…</th><th>ç¨æŠœåˆè¨ˆ</th></tr></thead><tbody>';
        
        results.forEach(result => {
            if (!result.failed && result.result && result.result.extracted_data) {
                const data = result.result.extracted_data;
                if (Array.isArray(data)) {
                    data.forEach(item => {
                        html += '<tr>';
                        html += `<td>${result.filename}</td>`;
                        html += `<td>${item.ãƒšãƒ¼ã‚¸ || 'N/A'}</td>`;
                        html += `<td>${item.å‡ºè·æ—¥ || 'N/A'}</td>`;
                        html += `<td>${item.å—æ³¨ç•ªå· || 'N/A'}</td>`;
                        html += `<td>${item.ç´å…¥å…ˆç•ªå· || 'N/A'}</td>`;
                        html += `<td>${item.æ‹…å½“è€… || 'N/A'}</td>`;
                        html += `<td>${addCommas(item.ç¨æŠœåˆè¨ˆ) || 'N/A'}</td>`;
                        html += '</tr>';
                    });
                } else if (typeof data === 'object') {
                    html += '<tr>';
                    html += `<td>${result.filename}</td>`;
                    html += `<td>${data.ãƒšãƒ¼ã‚¸ || 'N/A'}</td>`;
                    html += `<td>${data.å‡ºè·æ—¥ || 'N/A'}</td>`;
                    html += `<td>${data.å—æ³¨ç•ªå· || 'N/A'}</td>`;
                    html += `<td>${data.ç´å…¥å…ˆç•ªå· || 'N/A'}</td>`;
                    html += `<td>${item.æ‹…å½“è€… || 'N/A'}</td>`;
                    html += `<td>${addCommas(data.ç¨æŠœåˆè¨ˆ) || 'N/A'}</td>`;
                    html += '</tr>';
                }
            }
        });
        
        html += '</tbody></table></div>';
        html += '</div>';
    }
    
    uploadResults.innerHTML = html;
    uploadResultsArea.style.display = 'block';
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†å¾Œã®åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', function() {
    // ãƒªãƒˆãƒ©ã‚¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
    const retryFailedBtn = document.getElementById('retryFailedBtn');
    if (retryFailedBtn) {
        retryFailedBtn.addEventListener('click', handleRetryFailedClick);
    }
    
    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®å‡¦ç†
    const fileInput = document.getElementById('fileInput');
    
    if (fileInput) {
        fileInput.addEventListener('change', (e) => {
            const files = e.target.files;
            if (files.length > 0) {
                let validFiles = 0;
                let totalSize = 0;
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    if (!isValidPNGFile(file)) {
                        continue;
                    }
                    
                    if (file.size > 16 * 1024 * 1024) {
                        continue;
                    }
                    
                    validFiles++;
                    totalSize += file.size;
                }
                
                if (validFiles === 0) {
                    fileInput.value = '';
                    return;
                }
                
                // å¸¸ã«é€²æ—è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
                displayFileList(files);
            }
        });
    }
});

</script>
{% endblock %}
